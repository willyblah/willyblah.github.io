(async()=>{const t=window.supabase.createClient("https://kpubyiygmclpduyqsmkj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwdWJ5aXlnbWNscGR1eXFzbWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0Mzk1MTYsImV4cCI6MjA3NjAxNTUxNn0.ukWPhs7dWZ2FJv9rYZO5YvSpthFIy5IbMVy0mBkl8Tk"),e=t=>document.querySelector(t),n=e("#loading-indicator");function a(){n.classList.remove("hidden")}function i(){n.classList.add("hidden")}const o={Spear:{attack:5,acc:.5,price:0,default:!0,infinite:!0,desc:"Attack 5, 50% accuracy."},Knife:{attack:2,acc:.8,price:0,default:!0,infinite:!0,desc:"Attack 2, 80% accuracy."},Multiknife:{attack:10,acc:.8,price:2,desc:"Attack 10, 80% accuracy."},Multispear:{attack:20,acc:.8,price:4,desc:"Attack 20, 80% accuracy."},"Stone Sword":{attack:30,acc:1,price:6,desc:"Attack 30, 100% accuracy."},Kick:{attack:50,acc:.8,price:9,desc:"Attack 50, 80% accuracy."},Minibomb:{attack:60,acc:1,price:11,desc:"Attack 60, 100% accuracy."},Flame:{attack:80,acc:1,price:15,desc:"Attack 80, 100% accuracy."},Oneskill:{attack:100,acc:.8,price:18,desc:"Attack 100, 80% accuracy."},Minitrident:{attack:120,acc:1,price:23,desc:"Attack 120, 100% accuracy. +30 attack if used in water."},Fireball:{attack:150,acc:1,price:28,desc:"Attack 150, 100% accuracy."},"Iron Sword":{attack:200,acc:1,price:38,desc:"Attack 200, 100% accuracy."},Bombie:{attack:250,acc:1,price:48,desc:"Attack 250, 100% accuracy."},Punchie:{attack:300,acc:1,price:57,desc:"Attack 300, 100% accuracy."},Rage:{attack:350,acc:1,price:74,desc:"Attack 350, 100% accuracy. Requires Living of the Dark!"},Blast:{attack:400,acc:.8,price:77,desc:"Attack 400, 80% accuracy."},MillionSkills:{attack:500,acc:1,price:96,desc:"Attack 500, 100% accuracy."}},r={Dizzydizzy:{price:15,desc:"Gives you two extra turns."},Pushie:{price:17,desc:"Pushes opponent toward nearest edge."},Speed:{price:8,desc:"Speed +50% for 10s."},"Emergency Platform":{price:15,desc:"Automatically saves you from falling into the void."}},s={normal:{minHealth:5,maxHealth:150,minSkills:["Spear","Knife"],maxSkills:["Spear","Knife","Multiknife","Multispear","Stone Sword","Kick","Minibomb","Flame","Oneskill"]},underworld:{minHealth:150,maxHealth:1050,minSkills:["Spear","Knife","Multiknife","Multispear","Stone Sword","Kick","Minibomb","Flame","Oneskill"],maxSkills:["Spear","Knife","Multiknife","Multispear","Stone Sword","Kick","Minibomb","Flame","Oneskill","Minitrident","Fireball","Iron Sword","Bombie","Punchie","Rage","Blast","MillionSkills"]}};let l="normal",c=null;async function d(){a();try{const{data:{user:e},error:n}=await t.auth.getUser();if(n||!e||!e.email_confirmed_at)return f();const{data:a,error:i}=await t.from("profiles").select("*").eq("id",e.id).single();if(i||!a){const n=f(),{error:a}=await t.from("profiles").insert({id:e.id,username:e.user_metadata.username||"Anonymous",diamonds:n.diamonds,max_health:n.maxHealth,owned_skills:n.ownedSkills,owned_tactics:n.ownedTactics,profile:n.profile});if(a)throw a;return n}const s=a.owned_skills||{},l=Object.fromEntries(Object.keys(o).map(t=>[t,o[t].infinite?1/0:s[t]??0])),c=a.owned_tactics||{},d=Object.fromEntries(Object.keys(r).map(t=>[t,c[t]??0]));return{diamonds:a.diamonds||0,maxHealth:a.max_health||10,ownedSkills:l,ownedTactics:d,profile:a.profile||null}}catch(t){return c=`Load fail: ${t.message}`,f()}finally{i()}}function f(){return{diamonds:0,maxHealth:10,ownedSkills:Object.fromEntries(Object.keys(o).map(t=>[t,o[t].default?1/0:0])),ownedTactics:Object.fromEntries(Object.keys(r).map(t=>[t,0])),profile:null}}async function u(e){a();try{const{data:{user:n}}=await t.auth.getUser();if(!n||!n.email_confirmed_at)return;const{error:a}=await t.from("profiles").update({diamonds:e.diamonds,max_health:e.maxHealth,owned_skills:e.ownedSkills,owned_tactics:e.ownedTactics,profile:e.profile}).eq("id",n.id);if(a)throw a}catch(t){Zt(`Failed to save progress: ${t.message}`,"error")}finally{i()}}let h=await d();const m={start:e("#start-screen"),battle:e("#battle-screen"),shop:e("#shop-screen"),scale:e("#scale-screen"),signup:e("#signup-screen"),login:e("#login-screen"),verify:e("#verify-screen"),profile:e("#profile-screen"),prize:e("#prize-screen")},p=e("#tooltip"),y=e("#messages"),b=e("#start-health"),v=e("#start-diamonds"),M=e("#start-profile"),x=e("#start-skills"),k=e("#start-tactics"),g=e("#battle-skills"),w=e("#battle-tactics"),T=e("#player-hp-fill"),S=e("#opponent-hp-fill"),E=e("#player-health-text"),L=e("#opponent-health-text"),C=e("#turn-indicator"),$=e("#btn-battle"),O=e("#btn-shop"),A=e("#btn-surrender"),H=e("#scale-dot"),z=e("#btn-stop-scale"),P=e("#btn-start-battle"),D=e("#btn-scale-back"),I=e("#opponent-preview"),j=e("#preview-health"),Y=e("#preview-skills"),N=e("#preview-tactics"),R=e("#level-select"),F=e("#shop-diamonds"),B=e("#shop-skills"),q=e("#shop-tactics"),_=e("#btn-buy-health"),W=e("#health-amount"),V=e("#btn-change-profile"),K=e("#btn-shop-back"),J=e("#signup-form"),Q=e("#login-form"),X=e("#btn-signup"),U=e("#btn-login"),Z=e("#btn-logout"),G=e("#btn-signup-back"),tt=e("#btn-login-back"),et=e("#btn-verify-back"),nt=e("#signup-username"),at=e("#signup-email"),it=e("#signup-password"),ot=e("#login-identifier"),rt=e("#login-password"),st=e("#user-greeting"),lt=e("#prize-dot"),ct=e("#btn-stop-prize"),dt=e("#prize-result p"),ft=e("#btn-prize-back"),ut=e("#game-canvas"),ht=ut.getContext("2d"),mt=document.createElement("canvas");mt.width=ut.width,mt.height=ut.height;const pt=mt.getContext("2d"),yt=40,bt=Math.floor(ut.width/yt),vt=Math.floor(ut.height/yt);function Mt(){const t=Array.from({length:vt},()=>Array(bt).fill(0)),e=Math.max(1,bt-2),n=Math.max(1,vt-2);for(let a=1;a<1+n;a++)for(let n=1;n<1+e;n++)t[a][n]=1;t[2][2]=1,t[1+n-2][1+e-2]=1,t[n/2][0]=7,t[n/2][bt-1]=7;for(let a=0;a<60;a++){const a=2+Math.floor(Math.random()*(n-2)),i=2+Math.floor(Math.random()*(e-2));Math.random()<.28&&(t[a][i]=2)}for(let a=0;a<18;a++){const a=3+Math.floor(Math.random()*(n-4)),i=3+Math.floor(Math.random()*(e-4));1===t[a][i]&&Math.random()<.5&&(t[a][i]=3)}for(let a=0;a<12;a++){const a=3+Math.floor(Math.random()*(n-4)),i=3+Math.floor(Math.random()*(e-4));1===t[a][i]&&Math.random()<.35&&(t[a][i]=4)}for(let a=0;a<16;a++){const a=3+Math.floor(Math.random()*(n-4)),i=3+Math.floor(Math.random()*(e-4));1===t[a][i]&&Math.random()<.4&&(t[a][i]=5)}for(let a=0;a<12;a++){const a=3+Math.floor(Math.random()*(n-4)),i=3+Math.floor(Math.random()*(e-4));1===t[a][i]&&Math.random()<.3&&(t[a][i]=6)}for(let a=0;a<18;a++){const a=3+Math.floor(Math.random()*(n-4)),i=3+Math.floor(Math.random()*(e-4));1===t[a][i]&&Math.random()<.35&&(t[a][i]=0)}return t}function xt(t,e){return t>=0&&t<vt&&e>=0&&e<bt}function kt(t,e){if(!xt(t,e))return!1;const n=Ot[t][e];return 0!==n&&2!==n}function gt(t,e){return{x:t*yt+20,y:e*yt+20}}function wt(t,e){if(!xt(t,e))return 9999;switch(Ot[t][e]){case 1:return 1;case 3:return 1.2;case 4:return 8;case 5:return 4;case 6:return 1.5;default:return 9999}}function Tt(t,e,n,a,i=1){const o=Math.abs(e-a),r=Math.abs(t-n);return i*(1*(o+r)+(Math.SQRT2-2)*Math.min(o,r))}function St(t,e){const n=o[t];if(!n)return 0;let a=n.attack||0;const i=ye(e.x,e.y);return"Minitrident"===t&&3===i?a+=30:"Rage"===t&&e.fogMode&&(a*=2),a}function Et(t,e,n,a,i=4e3){const o=Math.floor(t/yt),r=Math.floor(e/yt),s=Math.floor(n/yt),l=Math.floor(a/yt);if(!kt(r,o)||!kt(l,s))return null;const c=r+","+o,d=l+","+s;let f=1/0;for(let t=0;t<vt;t++)for(let e=0;e<bt;e++){const n=Ot[t][e];1!==n&&3!==n&&6!==n||(f=Math.min(f,wt(t,e)))}isFinite(f)||(f=1);const u=new Map,h=new Set;function m(t,e){return[{r:t-1,c:e,moveCost:1},{r:t+1,c:e,moveCost:1},{r:t,c:e-1,moveCost:1},{r:t,c:e+1,moveCost:1},{r:t-1,c:e-1,moveCost:Math.SQRT2},{r:t-1,c:e+1,moveCost:Math.SQRT2},{r:t+1,c:e-1,moveCost:Math.SQRT2},{r:t+1,c:e+1,moveCost:Math.SQRT2}]}u.set(c,{r:r,c:o,g:0,f:Tt(r,o,l,s,f),parent:null});let p=0;for(;u.size&&p++<i;){let t=null,e=1/0;for(const[n,a]of u)a.f<e&&(e=a.f,t=n);const n=u.get(t);u.delete(t);const a=n.r+","+n.c;if(h.add(a),a===d){const t=[];let e=n;for(;e;)t.push({r:e.r,c:e.c,x:gt(e.c,e.r).x,y:gt(e.c,e.r).y}),e=e.parent;return t.reverse()}const i=m(n.r,n.c);for(const t of i){const e=t.r+","+t.c;if(!xt(t.r,t.c))continue;if(h.has(e))continue;if(!kt(t.r,t.c))continue;if(t.moveCost===Math.SQRT2){const e=n.r+(t.r-n.r),a=n.c,i=n.r,o=n.c+(t.c-n.c);if(!kt(e,a)||!kt(i,o))continue}const a=t.moveCost,i=.5*(wt(n.r,n.c)+wt(t.r,t.c)),o=n.g+a*i,r=u.get(e);if(!r||o<r.g){const a=Tt(t.r,t.c,l,s,f);u.set(e,{r:t.r,c:t.c,g:o,f:o+a,parent:n})}}}return null}function Lt(t,e){if(!e||e.length<2)return!1;let n=0,a=1/0;for(let i=0;i<Math.min(e.length,4);i++){const o=t.x-e[i].x,r=t.y-e[i].y,s=o*o+r*r;s<a&&(a=s,n=i)}const i=e[Math.min(e.length-1,n+1)],o=i.x-t.x,r=i.y-t.y,s=Math.hypot(o,r)||1;return t.vx=o/s*t.getSpeed(),t.vy=r/s*t.getSpeed(),!0}function Ct(t){let e=null,n=null;for(let n=0;n<vt;n++){for(let a=0;a<bt;a++)if(1===t[n][a]){e=[a*yt+20,n*yt+20];break}if(e)break}for(let e=vt-1;e>=0;e--){for(let a=bt-1;a>=0;a--)if(1===t[e][a]){n=[a*yt+20,e*yt+20];break}if(n)break}return{first:e,second:n}}class $t{constructor(t,e,n,a,i){this.x=t,this.y=e,this.vx=0,this.vy=0,this.hp=n,this.maxHp=n,this.speed=a,this.color=i,this.extraTurns=0,this.lastLavaTick=0,this.lastCactusTick=0,this.speedEffectEnd=0}applyDamage(t){this.hp-=t,this.hp<0&&(this.hp=0)}isDead(){return this.hp<=0}toggleFogMode(){this.fogMode=!this.fogMode}applySpeedBoost(t){this.speedEffectEnd=Date.now()+t}getSpeed(){return this.speedEffectEnd>Date.now()?1.5*this.speed:this.speed}}let Ot=Mt(),At=Ct(Ot),Ht=null,zt=null,Pt={},Dt={},It={},jt={},Yt=0,Nt=[],Rt={},Ft={battle:null},Bt=null,qt=1,_t=0,Wt=!1,Vt=.5,Kt=null,Jt=1,Qt=0,Xt=!1;const Ut={};function Zt(t,e="info",n=2e3){const a=document.createElement("div");return a.className=`message ${e}`,a.innerHTML=t,y.appendChild(a),setTimeout(()=>{a.style.animation="msgOut 300ms forwards",setTimeout(()=>a.remove(),320)},n),a}function Gt(){T.style.width=`${Math.max(0,Ht.hp/Ht.maxHp*100)}%`,S.style.width=`${Math.max(0,zt.hp/zt.maxHp*100)}%`,E&&(E.textContent=`${Math.max(0,Math.floor(Ht.hp))}/${Ht.maxHp}`),L&&(L.textContent=`${Math.max(0,Math.floor(zt.hp))}/${zt.maxHp}`),g.innerHTML="";Object.keys(o).filter(t=>Pt[t]&&0!==Pt[t]||Pt[t]===1/0).forEach(t=>{const e=o[t],n=Pt[t]===1/0?"∞":Pt[t]||0,a=document.createElement("div");a.className="skill-btn",a.dataset.name=t,a.innerHTML=`<div>${t}</div><div class="skill-count">${n}</div>`,a.addEventListener("click",()=>function(t){if(!Ft.battle)return;if(Date.now()<Ft.battle.startPeriodEnd)return;if("player"!==Ft.battle.currentActor)return;if(!Pt[t]||Pt[t]<=0&&Pt[t]!==1/0)return void Zt(`No <b>${t}</b> left!`,"warn");const e=St(t,Ht);Se(Ht,zt)&&Math.random()<(o[t].acc||1)?(zt.applyDamage(e),Zt(`You used <b>${t}</b>! Opponent loses ${e} HP.`,"info"),we(S,zt.hp/zt.maxHp*100)):Se(Ht,zt)?Zt(`You used <b>${t}</b>! Missed!`,"warn"):Zt(`You used <b>${t}</b>! Too far or blocked by wall.`,"warn");Pt[t]!==1/0&&(Pt[t]=Math.max(0,(Pt[t]||0)-1),0===Pt[t]&&Zt(`You have no <b>${t}</b> left.`,"warn"));Gt(),xe("player")}(t)),ee(a,e.desc),g.appendChild(a)}),w.innerHTML="";Object.keys(r).filter(t=>Dt[t]&&0!==Dt[t]).forEach(t=>{const e=r[t],n=Dt[t]||0,a=document.createElement("div");a.className="tactic-btn",a.dataset.name=t,a.innerHTML=`<div>${t}</div><div class="skill-count">${n}</div>`,"Emergency Platform"!==t&&a.addEventListener("click",()=>function(t){if(!Ft.battle)return;if(Date.now()<Ft.battle.startPeriodEnd)return;if("player"!==Ft.battle.currentActor)return;if(!Dt[t]||Dt[t]<=0)return;"Dizzydizzy"===t?(Ht.extraTurns+=2,Ft.battle&&(Ft.battle.turnEndTime=Date.now()+(Ft.battle.turnTimeout||1e4)),Zt(`You used <b>${t}</b>! 2 extra turns.`,"info")):"Pushie"===t?(Ce(zt),Zt(`You used <b>${t}</b>! Opponent was pushed.`,"info")):"Speed"===t&&(Ht.applySpeedBoost(1e4),Zt(`You used <b>${t}</b>! Speed up 10s.`,"info"));Dt[t]=Math.max(0,Dt[t]-1),0===Dt[t]&&Zt(`You have no <b>${t}</b> left.`,"warn");Gt(),xe("player")}(t)),ee(a,`${t}<br>${e.desc}`),w.appendChild(a)})}function te(){F.textContent=h.diamonds+("Villager"===h.profile?" (50% off!)":""),B.innerHTML="",q.innerHTML="",Object.keys(o).forEach(t=>{const e=o[t],n=document.createElement("div");n.className="shop-item",n.innerHTML=`<div><b>${t}</b><div style="font-size:13px;color:var(--muted)">${e.desc}</div></div>\n        <div style="display:flex;gap:8px;align-items:center">\n        <div style="color:var(--muted);font-weight:600">${e.price?"Villager"===h.profile?Math.ceil(e.price/2):e.price:"—"}</div>\n        <button class="btn" data-name="${t}">Buy</button>\n        </div>`,n.querySelector("button").addEventListener("click",()=>{!async function(t){a();try{const e=o[t];if(!e.price)return void Zt(`<b>${t}</b> cannot be purchased.`,"warn");let n=e.price;if("Villager"===h.profile&&(n=Math.ceil(n/2)),h.diamonds<n)return void Zt("Not enough diamonds.","error");h.diamonds-=n,h.ownedSkills[t]=(h.ownedSkills[t]||0)+1,await u(h),te(),Zt(`Bought <b>${t}</b>.`,"success")}finally{i()}}(t)}),B.appendChild(n)}),Object.keys(r).forEach(t=>{const e=r[t],n=document.createElement("div");n.className="shop-item",n.innerHTML=`<div><b>${t}</b><div style="font-size:13px;color:var(--muted)">${e.desc}</div></div>\n        <div style="display:flex;gap:8px;align-items:center">\n        <div style="color:var(--muted);font-weight:600">${"Villager"===h.profile?Math.ceil(e.price/2):e.price}</div>\n        <button class="btn" data-name="${t}">Buy</button>\n        </div>`,n.querySelector("button").addEventListener("click",()=>{!async function(t){a();try{let e=r[t].price;if("Villager"===h.profile&&(e=Math.ceil(e/2)),h.diamonds<e)return void Zt("Not enough diamonds.","error");h.diamonds-=e,h.ownedTactics[t]=(h.ownedTactics[t]||0)+1,await u(h),te(),Zt(`Bought <b>${t}</b>.`,"success")}finally{i()}}(t)}),q.appendChild(n)})}function ee(t,e){t.addEventListener("mouseenter",t=>{p.innerHTML=e,p.classList.remove("hidden"),ne(t.pageX,t.pageY)}),t.addEventListener("mousemove",t=>ne(t.pageX,t.pageY)),t.addEventListener("mouseleave",()=>{p.classList.add("hidden")})}function ne(t,e){p.style.left=t+12+"px",p.style.top=e+12+"px"}function ae(){Ot=Mt(),At=Ct(Ot);const t=h.maxHealth;Ht=new $t(At.first[0],At.first[1],t,140,"#10b981"),Ht.fogMode=!1,zt=new $t(At.second[0],At.second[1],Yt,140,"#ef4444"),zt.isChasing=!1,Pt={},Dt={},It={},jt=Rt||{},Object.keys(o).forEach(t=>{const e=h.ownedSkills[t];Pt[t]=e===1/0?1/0:e||0});const e=Object.keys(o).sort((t,e)=>o[e].attack-o[t].attack);let n=1;e.forEach(t=>{It[t]=Nt.includes(t)?n++:0,"Spear"!==t&&"Knife"!==t||(It[t]=1/0)}),Object.keys(r).forEach(t=>{Dt[t]=h.ownedTactics[t]||0}),Gt();const a=document.querySelector(".sidepanel");a&&(a.scrollTop=0);Ft.battle={startPeriodEnd:Date.now()+5e3,currentActor:null,turnEndTime:null,turnTimeout:1e4,battleOver:!1,startTime:Date.now()},setTimeout(()=>{Ft.battle.currentActor=Math.random()<.5?"player":"opponent",Ft.battle.turnEndTime=Date.now()+Ft.battle.turnTimeout,ge(),"opponent"===Ft.battle.currentActor&&Te()},5050),de=performance.now(),ce||(ce=requestAnimationFrame(ue))}async function ie(t){a();try{h.profile=t,await u(h),re()}finally{i()}}function oe(t){Object.keys(m).forEach(e=>{m[e].classList.toggle("hidden",e!==t)})}async function re(){h=await d(),oe("start"),async function(){b.textContent=h.maxHealth,v.textContent=h.diamonds,h.profile?M.textContent=h.profile:M.textContent="None",x.innerHTML="",k.innerHTML="",Object.keys(o).filter(t=>h.ownedSkills[t]&&0!==h.ownedSkills[t]).forEach(t=>{const e=o[t],n=h.ownedSkills[t]===1/0?"∞":h.ownedSkills[t],a=document.createElement("div");a.className="skill-btn",a.dataset.name=t,a.innerHTML=`<div>${t}</div><div class="skill-count">${n}</div>`,ee(a,e.desc),x.appendChild(a)}),Object.keys(r).filter(t=>h.ownedTactics[t]&&0!==h.ownedTactics[t]).forEach(t=>{const e=r[t],n=h.ownedTactics[t]||0,a=document.createElement("div");a.className="tactic-btn",a.dataset.name=t,a.innerHTML=`<div>${t}</div><div class="skill-count">${n}</div>`,ee(a,e.desc),k.appendChild(a)});const{data:{user:e}}=await t.auth.getUser();e?(X.classList.add("hidden"),U.classList.add("hidden"),Z.classList.remove("hidden"),st.classList.remove("hidden"),st.textContent=e.user_metadata.username||"Anonymous"):(X.classList.remove("hidden"),U.classList.remove("hidden"),Z.classList.add("hidden"),st.classList.add("hidden"))}(),c&&Zt(c,"error",3e3)}function se(){oe("profile")}function le(){Bt&&(clearInterval(Bt),Bt=null),Wt=!0,Vt=_t/100,I.classList.remove("hidden"),P.disabled=!1,Yt=function(){const t=s[l],e=t.maxHealth-t.minHealth;return Math.floor(t.minHealth+Vt*e)}(),Nt=function(){const t=s[l],e=Math.floor(t.minSkills.length+Vt*(t.maxSkills.length-t.minSkills.length));return t.maxSkills.slice(0,Math.max(t.minSkills.length,e))}(),Rt=function(){const t=Object.keys(r),e={};if(t.forEach(t=>{e[t]=0}),"normal"===l){if(Vt>=.25&&Vt<.5){const n=t[Math.floor(Math.random()*t.length)];e[n]=1}else if(Vt>=.5&&Vt<.75){const n=t[Math.floor(Math.random()*t.length)];e[n]=2}else if(Vt>=.75&&Vt<=1){const n=[...t].sort(()=>.5-Math.random()).slice(0,2);e[n[0]]=1,e[n[1]]=2}}else if(Vt>=0&&Vt<.25)[...t].sort(()=>.5-Math.random()).slice(0,2).forEach(t=>{e[t]=2});else if(Vt>=.25&&Vt<.5){const n=[...t].sort(()=>.5-Math.random()).slice(0,3);e[n[0]]=2,e[n[1]]=2,e[n[2]]=1}else if(Vt>=.5&&Vt<.75){const n=[...t].sort(()=>.5-Math.random()).slice(0,3);e[n[0]]=3,e[n[1]]=2,e[n[2]]=2}else Vt>=.75&&Vt<=1&&t.forEach(t=>{e[t]=2});return e}(),j.textContent=Yt,Y.textContent=Nt.join(", ");const t=Object.entries(Rt).filter(([t,e])=>e>0).map(([t,e])=>`${t}`).join(", ");N.textContent=t||"None"}window.addEventListener("keydown",t=>{const e=t.key.toLowerCase();"tab"===e&&m.login.classList.contains("hidden")&&m.signup.classList.contains("hidden")&&t.preventDefault(),Ut[e]=!0}),window.addEventListener("keyup",t=>{Ut[t.key.toLowerCase()]=!1}),_.addEventListener("click",()=>{const t=parseInt(W.value,10);isNaN(t)||t<5||t%5!=0?Zt("Enter a multiple of 5 (minimum 5).","error"):async function(t){a();try{let e=t/5;if("Villager"===h.profile&&(e=Math.ceil(e/2)),h.diamonds<e)return void Zt("Not enough diamonds.","error");h.diamonds-=e,h.maxHealth+=t,await u(h),te(),Zt(`Bought ${t} health. You have ${h.maxHealth} health now.`,"success")}finally{i()}}(t)}),W.addEventListener("click",t=>{t.stopPropagation()}),V.addEventListener("click",async()=>{h.diamonds<5?Zt("Not enough diamonds.","error"):(h.diamonds-=5,await u(h),se())}),$.addEventListener("click",()=>{oe("scale"),I.classList.add("hidden"),P.disabled=!0,z.disabled=!1,z.textContent="Stop",Wt=!1,_t=50,qt=1,H.style.left="50%",Bt=setInterval(()=>{_t+=2*qt,_t>=100?(_t=100,qt=-1):_t<=0&&(_t=0,qt=1),H.style.left=_t+"%"},30)}),O.addEventListener("click",()=>{oe("shop"),te()}),A.addEventListener("click",()=>{Ft.battle&&Oe(!1,"You surrendered.")}),K.addEventListener("click",()=>{re()}),z.addEventListener("click",()=>{Wt||(le(),z.disabled=!0,z.textContent="Stopped")}),P.addEventListener("click",()=>{oe("battle"),ae()}),D.addEventListener("click",()=>{Wt||le(),re()}),R.addEventListener("change",()=>{l=R.value}),X.addEventListener("click",()=>{oe("signup")}),U.addEventListener("click",()=>{oe("login")}),Z.addEventListener("click",async()=>{await t.auth.signOut(),h=f(),re()}),G.addEventListener("click",()=>re()),tt.addEventListener("click",()=>re()),et.addEventListener("click",()=>re()),J.addEventListener("submit",async e=>{e.preventDefault();const n=nt.value.trim(),o=at.value.trim(),r=it.value.trim(),s=J.querySelector('button[type="submit"]');if(n&&o&&r){s.disabled=!0,a();try{const{data:{user:e},error:a}=await t.auth.signUp({email:o,password:r,options:{data:{username:n}}});if(a)throw a;e&&oe("verify")}catch(t){Zt(`Sign up failed: ${t.message}`,"error",3e3)}finally{s.disabled=!1,i()}}else Zt("All fields required.","error")}),Q.addEventListener("submit",async e=>{e.preventDefault();const n=ot.value.trim(),o=rt.value.trim(),r=Q.querySelector('button[type="submit"]');if(n&&o){r.disabled=!0,a();try{const{data:{user:e},error:a}=await t.auth.signInWithPassword({email:n,password:o});if(a)throw a;h=await d(),h.profile?re():se()}catch(t){Zt(`Log in failed: ${t.message}`,"error",3e3)}finally{r.disabled=!1,i()}}else Zt("All fields required.","error")}),e("#btn-warrior").addEventListener("click",()=>ie("Warrior")),e("#btn-miner").addEventListener("click",()=>ie("Miner")),e("#btn-trickster").addEventListener("click",()=>ie("Trickster")),e("#btn-villager").addEventListener("click",()=>ie("Villager")),ct.addEventListener("click",()=>{if(!Xt)if(clearInterval(Kt),Xt=!0,ct.disabled=!0,dt.parentNode.classList.remove("hidden"),Qt>50){const t=1+Math.floor(5*Math.random());if(Math.random()<.5){const e=5*t;h.maxHealth+=e,dt.innerHTML=`Prize: <b>${e} health</b>!`}else h.diamonds+=t,dt.innerHTML=`Prize: <b>${t} diamond(s)</b>!`;u(h)}else dt.textContent="Sorry, no prize."}),ft.addEventListener("click",()=>{re()});let ce=null,de=performance.now();function fe(){ce&&cancelAnimationFrame(ce),ce=null,Ft.battle=null}function ue(t){const e=Math.min(50,t-de)/1e3;de=t,function(t){if(!Ft.battle)return;const e=Date.now();let n=Ht.getSpeed();if(Ut.w||Ut.a||Ut.s||Ut.d){let t=0,e=0;Ut.w&&(e-=1),Ut.s&&(e+=1),Ut.a&&(t-=1),Ut.d&&(t+=1);const a=Math.hypot(t,e)||1;t/=a,e/=a,Ht.vx=t*n,Ht.vy=e*n}else Ht.vx*=.8,Ht.vy*=.8;const a=Ft.battle&&Ft.battle.currentActor;if("opponent"===a||!zt.hasOwnProperty("aiTimer")||zt.aiTimer<Date.now()){const t=Math.hypot(Ht.x-zt.x,Ht.y-zt.y);if("player"===a)t<260?function(t,e,n){let a=null,i=-1/0;for(let o=0;o<2*Math.PI;o+=Math.PI/6){const r=t.x+Math.cos(o)*yt*3,s=t.y+Math.sin(o)*yt*3;if(r<10||s<10||r>ut.width-10||s>ut.height-10)continue;const l=ye(r,s);if(0===l||2===l||4===l)continue;const c=Math.hypot(r-e,s-n);c>i&&(i=c,a={x:r,y:s})}if(a){const e=Et(t.x,t.y,a.x,a.y);e&&e.length>1&&Lt(t,e)}}(zt,Ht.x,Ht.y):(zt.vx*=.85,zt.vy*=.85),zt.isChasing&&(zt.isChasing=!1);else if(Se(zt,Ht))zt.vx*=.85,zt.vy*=.85,zt.isChasing&&(zt.isChasing=!1,(!zt.aiTimer||zt.aiTimer<Date.now())&&Te());else{const t=Et(zt.x,zt.y,Ht.x,Ht.y);t?Lt(zt,t):$e(zt,Ht.x,Ht.y),zt.isChasing=!0}}if(he(Ht,t),he(zt,t),me(Ht,t),me(zt,t),be(Ht.x,Ht.y)){if(!(Dt["Emergency Platform"]&&Dt["Emergency Platform"]>0))return Ht.hp=0,we(T,0),void setTimeout(()=>Oe(!1,"You fell into the void."),600);pe(Ht.x,Ht.y)&&(Dt["Emergency Platform"]--,Gt())}if(be(zt.x,zt.y)){if(!(jt["Emergency Platform"]&&jt["Emergency Platform"]>0))return zt.hp=0,we(S,0),void setTimeout(()=>Oe(!0,"Opponent fell into the void."),600);pe(zt.x,zt.y)&&(jt["Emergency Platform"]--,Gt())}if(Ht.isDead())return we(T,0),void setTimeout(()=>Oe(!1,"You died."),600);if(zt.isDead())return we(S,0),void setTimeout(()=>Oe(!0,"Opponent died."),600);e<Ft.battle.startPeriodEnd?C.textContent=`Starting in ${Math.ceil((Ft.battle.startPeriodEnd-e)/1e3)}s`:(Ft.battle.currentActor?Ft.battle.turnEndTime&&e>Ft.battle.turnEndTime&&ke():(Ft.battle.currentActor=Math.random()<.5?"player":"opponent",Ft.battle.turnEndTime=e+Ft.battle.turnTimeout,ge()),ge());T.style.width=Ht.hp/Ht.maxHp*100+"%",S.style.width=zt.hp/zt.maxHp*100+"%",E.textContent=`${Math.max(0,Math.floor(Ht.hp))}/${Ht.maxHp}`,L.textContent=`${Math.max(0,Math.floor(zt.hp))}/${zt.maxHp}`}(e),function(){ht.clearRect(0,0,ut.width,ut.height);for(let t=0;t<vt;t++)for(let e=0;e<bt;e++){const n=Ot[t][e],a=e*yt,i=t*yt;0===n?(ht.fillStyle="#7fbfff",ht.fillRect(a,i,yt,yt),Me(ht,e*yt+20,t*yt+20,16)):1===n?(ht.fillStyle="#6b8f5a",ht.fillRect(a,i,yt,yt)):2===n?(ht.fillStyle="#5b5b5b",ht.fillRect(a,i,yt,yt)):3===n?(ht.fillStyle="#4ea0ff",ht.fillRect(a,i,yt,yt)):4===n?(ht.fillStyle="#ff7a4d",ht.fillRect(a,i,yt,yt)):5===n?(ht.fillStyle="#7ad17a",ht.fillRect(a,i,yt,yt),ht.fillStyle="#2a7a2a",ht.fillRect(a+18,i+8,4,24)):6===n?(ht.fillStyle="#8fb8c6",ht.fillRect(a,i,yt,yt),ht.fillStyle="#ffffff",ht.font="40px Inter",ht.textAlign="center",ht.textBaseline="middle",ht.fillText("*",a+20,i+20+8)):7===n&&(ht.fillStyle="#8b5a2b",ht.fillRect(a,i,yt,yt),ht.fillStyle="#ffffff",ht.font="16px Inter",ht.textAlign="center",ht.textBaseline="middle",ht.fillText("MIST",a+20,i+20)),ht.strokeStyle="rgba(0,0,0,0.05)",ht.strokeRect(a,i,yt,yt)}ve(Ht,"P"),(!Ht.fogMode||Math.hypot(zt.x-Ht.x,zt.y-Ht.y)<=80)&&ve(zt,"O");Ht&&Ht.fogMode&&(pt.fillStyle="#707070",pt.fillRect(0,0,mt.width,mt.height),pt.globalCompositeOperation="destination-out",pt.beginPath(),pt.arc(Ht.x,Ht.y,80,0,2*Math.PI),pt.fill(),pt.globalCompositeOperation="source-over",ht.drawImage(mt,0,0))}(),Ft.battle&&!Ft.battle.battleOver?ce=requestAnimationFrame(ue):fe()}function he(t,e){const n=ye(t.x,t.y);let a=1;3===n&&(a=.6),6===n&&(a=.5);const i=t.x,o=t.y;t.x+=t.vx*e*a,t.y+=t.vy*e*a;const r=Math.floor(i/yt),s=Math.floor(o/yt),l=Math.floor(t.x/yt),c=Math.floor(t.y/yt);if(c!==s&&l!==r&&!(xt(s,l)&&2!==Ot[s][l]||xt(c,r)&&2!==Ot[c][r]))return t.x=i,t.y=o,t.vx=0,void(t.vy=0);2===ye(t.x,t.y)&&(t.x=i,t.y=o,t.x+=t.vx*e*a,2===ye(t.x,t.y)&&(t.x=i),t.y+=t.vy*e*a,2===ye(t.x,t.y)&&(t.y=o),2===ye(t.x,t.y)&&(t.x=i,t.y=o,t.vx=0,t.vy=0)),t.x=Math.max(10,Math.min(ut.width-10,t.x)),t.y=Math.max(10,Math.min(ut.height-10,t.y))}function me(t,e){const n=Date.now(),a=ye(t.x,t.y);4===a?(t.lastLavaTick||(t.lastLavaTick=n),n-t.lastLavaTick>=250&&(t.applyDamage(20),t.lastLavaTick=n,t===Ht&&Zt("Sizzling in lava!","warn"))):t.lastLavaTick=0,5===a?(t.lastCactusTick||(t.lastCactusTick=n),n-t.lastCactusTick>=250&&(t.applyDamage(5),t.lastCactusTick=n,t===Ht&&Zt("Pricked by cactus!","warn"))):t.lastCactusTick=0,7===a?(!t.lastMistToggle||n-t.lastMistToggle>=3e3)&&(t.toggleFogMode(),Zt(t.fogMode?"Mist obscures your vision!":"Vision restored!","info"),t.lastMistToggle=n):t.lastMistToggle=0}function pe(t,e){const n=Math.floor(t/yt),a=Math.floor(e/yt);return!(!xt(a,n)||0!==Ot[a][n])&&(Ot[a][n]=1,Zt("Emergency Platform activated!","success"),!0)}function ye(t,e){const n=Math.floor(t/yt),a=Math.floor(e/yt);return a<0||a>=vt||n<0||n>=bt?0:Ot[a][n]}function be(t,e){const n=Math.floor(t/yt),a=Math.floor(e/yt);return a<0||a>=vt||n<0||n>=bt||0===Ot[a][n]}function ve(t,e){ht.save(),ht.beginPath(),ht.fillStyle=t.color,ht.strokeStyle="#000",ht.lineWidth=2,ht.arc(t.x,t.y,14,0,2*Math.PI),ht.fill(),ht.stroke(),ht.closePath(),ht.fillStyle="#fff",ht.font="bold 14px Inter",ht.textAlign="center",ht.textBaseline="middle",ht.fillText(e,t.x,t.y),ht.restore()}function Me(t,e,n,a){t.save(),t.strokeStyle="black",t.lineWidth=2,t.beginPath(),t.moveTo(e,n-a/2),t.lineTo(e,n+a/4),t.stroke(),t.beginPath(),t.moveTo(e-a/4,n),t.lineTo(e,n+a/2),t.lineTo(e+a/4,n),t.stroke(),t.restore()}function xe(t){if("player"===t){if(Ht.extraTurns>0)return void Ht.extraTurns--;ke()}else{if(zt.extraTurns>0)return zt.extraTurns--,void Te();ke()}}function ke(){Ft.battle&&("player"===Ft.battle.currentActor?(Ft.battle.currentActor="opponent",Ft.battle.turnEndTime=Date.now()+Ft.battle.turnTimeout,Te()):(Ft.battle.currentActor="player",Ft.battle.turnEndTime=Date.now()+Ft.battle.turnTimeout),ge())}function ge(){if(!Ft.battle)return;const t=Date.now();if(t<Ft.battle.startPeriodEnd)return void(C.textContent=`Starting in ${Math.ceil((Ft.battle.startPeriodEnd-t)/1e3)}s`);const e=Ft.battle.currentActor;if("player"===e){const e=Math.max(0,Math.ceil((Ft.battle.turnEndTime-t)/1e3));C.textContent=`Your turn — ${e}s`}else if("opponent"===e){const e=Math.max(0,Math.ceil((Ft.battle.turnEndTime-t)/1e3));C.textContent=`Opponent's turn — ${e}s`}else C.textContent="Waiting..."}function we(t,e){t.style.transition=0===e?"width 600ms ease":"width 400ms ease",t.style.width=`${e}%`}function Te(){if(!Ft.battle||"opponent"!==Ft.battle.currentActor)return;if(!Se(zt,Ht))return void(zt.isChasing=!0);const t=800+1e3*Math.random();zt.aiTimer=Date.now()+t,setTimeout(()=>{if(!Ft.battle||"opponent"!==Ft.battle.currentActor)return;if(!Se(zt,Ht))return void(zt.isChasing=!0);const t=ye(zt.x,zt.y);if(4===t||5===t){const t=function(t){const e=6;for(let n=-e;n<=e;n++)for(let a=-e;a<=e;a++){const e=t.x+a*yt,i=t.y+n*yt;if(e<=10||i<=10||e>=ut.width-10||i>=ut.height-10)continue;const o=ye(e,i);if(1===o||6===o)return{x:e,y:i}}return null}(zt);t&&$e(zt,t.x,t.y)}const e=Object.keys(o).filter(t=>It[t]&&0!==It[t]||It[t]===1/0),n=Object.keys(r).filter(t=>jt[t]&&jt[t]>0);for(const t of e){const e=o[t];let n=e.attack;const a=ye(zt.x,zt.y);if("Minitrident"===t&&3===a&&(n+=30),n>=Ht.hp&&Math.random()<(e.acc||1))return void Ee(t)}if(n.includes("Pushie")){const t=Ht.x,e=ut.width-Ht.x,n=Ht.y,a=ut.height-Ht.y;if(Math.min(t,e,n,a)<140&&Math.random()<.6)return void Le("Pushie")}if(n.includes("Dizzydizzy")&&Math.random()<.6)return void Le("Dizzydizzy");if(n.includes("Speed")&&zt.hp<=.6*zt.maxHp&&Math.random()<.5)return void Le("Speed");let a=null,i=-1/0;for(const t of e){const e=o[t];let n=e.attack;const r=ye(zt.x,zt.y);"Minitrident"===t&&3===r&&(n+=30);let s=e.acc||1;"Warrior"===h.profile&&(s=.5);const l=n*s;l>i&&(i=l,a=t)}a&&Ee(a),setTimeout(()=>{"opponent"===Ft.battle.currentActor&&ke()},800+600*Math.random())},t)}function Se(t,e){const n=e.x-t.x,a=e.y-t.y,i=Math.hypot(n,a);if(i>410)return!1;const o=Math.ceil(i/8);for(let e=1;e<o;e++){if(2===ye(t.x+n*(e/o),t.y+a*(e/o)))return!1}return!0}function Ee(t){if(!Ft.battle||"opponent"!==Ft.battle.currentActor)return;if(!It[t]||It[t]<=0&&It[t]!==1/0)return void ke();const e=St(t,zt);let n=o[t].acc||1;"Warrior"===h.profile&&(n=.5),Se(zt,Ht)&&Math.random()<n?(Ht.applyDamage(e),Zt(`Opponent used <b>${t}</b>! You lose ${e} HP.`,"error"),we(T,Ht.hp/Ht.maxHp*100)):Se(zt,Ht)?Zt(`Opponent used <b>${t}</b>! Missed!`,"info"):Zt(`Opponent used <b>${t}</b>! Too far or blocked by wall.`,"info"),It[t]!==1/0&&(It[t]=Math.max(0,It[t]-1)),xe("opponent")}function Le(t){Ft.battle&&"opponent"===Ft.battle.currentActor&&(!jt[t]||jt[t]<=0?ke():("Dizzydizzy"===t?(zt.extraTurns+=2,Ft.battle&&(Ft.battle.turnEndTime=Date.now()+(Ft.battle.turnTimeout||1e4)),Zt("Opponent used <b>Dizzydizzy</b>! They gain 2 extra turns.","warn")):"Pushie"===t?(Ce(Ht),Zt("Opponent used <b>Pushie</b>! You were pushed.","warn")):"Speed"===t&&(zt.applySpeedBoost(1e4),Zt("Opponent used <b>Speed</b>! Opponent speed +50% for 10s.","warn")),jt[t]=Math.max(0,jt[t]-1),xe("opponent")))}function Ce(t){const e=[{x:10,y:t.y},{x:ut.width-10,y:t.y},{x:t.x,y:10},{x:t.x,y:ut.height-10}];let n=null,a=1/0;for(const i of e){const e=Math.hypot(i.x-t.x,i.y-t.y);e<a&&(a=e,n=i)}const i=Math.min(100,a),o=Math.atan2(n.y-t.y,n.x-t.x);t.x+=Math.cos(o)*i,t.y+=Math.sin(o)*i}function $e(t,e,n){const a=Et(t.x,t.y,e,n);a&&a.length>1&&Lt(t,a)}async function Oe(t,e){if(!Ft.battle||Ft.battle.battleOver)return;const n=Ft.battle;Ft.battle.battleOver=!0,fe();let a=Math.floor(15*Vt)+("normal"===l?2:12);if(t?("Miner"===h.profile&&(a*=2),h.diamonds=(h.diamonds||0)+a,await u(h),Zt(`You win! ${e} Diamonds earned: ${a}`,"success")):Zt(`You lose. ${e}`,"error"),"Trickster"===h.profile){if(!(Date.now()-n.startTime<11e3))return oe("prize"),dt.parentNode.classList.add("hidden"),ct.disabled=!1,ct.textContent="Stop",Qt=0,Jt=1,lt.style.left="0%",Xt=!1,void(Kt=setInterval(()=>{Qt+=5*Jt,Qt>=100?(Qt=100,Jt=-1):Qt<=0&&(Qt=0,Jt=1),lt.style.left=Qt+"%"},30));Zt("Sorry, no cheating the prize! You must battle for a while.","warn",3e3)}re()}re()})();