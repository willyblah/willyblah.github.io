(async()=>{const t=window.supabase.createClient("https://kpubyiygmclpduyqsmkj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwdWJ5aXlnbWNscGR1eXFzbWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0Mzk1MTYsImV4cCI6MjA3NjAxNTUxNn0.ukWPhs7dWZ2FJv9rYZO5YvSpthFIy5IbMVy0mBkl8Tk"),e=t=>document.querySelector(t),n=e("#loading-indicator");function a(){n.classList.remove("hidden")}function i(){n.classList.add("hidden")}const o={Spear:{attack:5,acc:.5,price:0,default:!0,infinite:!0,desc:"Attack 5, 50% accuracy."},Knife:{attack:2,acc:.8,price:0,default:!0,infinite:!0,desc:"Attack 2, 80% accuracy."},Multiknife:{attack:10,acc:.8,price:2,desc:"Attack 10, 80% accuracy."},Multispear:{attack:20,acc:.8,price:4,desc:"Attack 20, 80% accuracy."},"Stone Sword":{attack:30,acc:1,price:6,desc:"Attack 30, 100% accuracy."},Kick:{attack:50,acc:.8,price:9,desc:"Attack 50, 80% accuracy."},Minibomb:{attack:60,acc:1,price:11,desc:"Attack 60, 100% accuracy."},Flame:{attack:80,acc:1,price:15,desc:"Attack 80, 100% accuracy."},Oneskill:{attack:100,acc:.8,price:18,desc:"Attack 100, 80% accuracy."},Minitrident:{attack:120,acc:1,price:23,desc:"Attack 120, 100% accuracy. +30 attack if used in water."},Fireball:{attack:150,acc:1,price:28,desc:"Attack 150, 100% accuracy."},"Iron Sword":{attack:200,acc:1,price:38,desc:"Attack 200, 100% accuracy."},Bombie:{attack:250,acc:1,price:48,desc:"Attack 250, 100% accuracy."},Punchie:{attack:300,acc:1,price:57,desc:"Attack 300, 100% accuracy."},Rage:{attack:350,acc:1,price:74,desc:"Attack 350, 100% accuracy. Requires Living of the Dark!"},Blast:{attack:400,acc:.8,price:77,desc:"Attack 400, 80% accuracy."},MillionSkills:{attack:500,acc:1,price:96,desc:"Attack 500, 100% accuracy."}},r={Dizzydizzy:{price:15,desc:"Gives you two extra turns."},Pushie:{price:17,desc:"Pushes opponent toward nearest edge."},Speed:{price:8,desc:"Speed +50% for 10s."},"Emergency Platform":{price:15,desc:"Automatically saves you from falling into the void."}},s={normal:{minHealth:5,maxHealth:150,minSkills:["Spear","Knife"],maxSkills:["Spear","Knife","Multiknife","Multispear","Stone Sword","Kick","Minibomb","Flame","Oneskill"]},underworld:{minHealth:150,maxHealth:1050,minSkills:["Spear","Knife","Multiknife","Multispear","Stone Sword","Kick","Minibomb","Flame","Oneskill"],maxSkills:["Spear","Knife","Multiknife","Multispear","Stone Sword","Kick","Minibomb","Flame","Oneskill","Minitrident","Fireball","Iron Sword","Bombie","Punchie","Rage","Blast","MillionSkills"]}};let c="normal",l=null;async function d(){a();try{const{data:{user:e},error:n}=await t.auth.getUser();if(n||!e||!e.email_confirmed_at)return u();const{data:a,error:i}=await t.from("profiles").select("*").eq("id",e.id).single();if(i||!a){const n=u(),{error:a}=await t.from("profiles").insert({id:e.id,username:e.user_metadata.username||"Anonymous",diamonds:n.diamonds,max_health:n.maxHealth,owned_skills:n.ownedSkills,owned_tactics:n.ownedTactics,profile:n.profile});if(a)throw a;return n}const s=a.owned_skills||{},c=Object.fromEntries(Object.keys(o).map(t=>[t,o[t].infinite?1/0:s[t]??0])),l=a.owned_tactics||{},d=Object.fromEntries(Object.keys(r).map(t=>[t,l[t]??0]));return{diamonds:a.diamonds||0,maxHealth:a.max_health||10,ownedSkills:c,ownedTactics:d,profile:a.profile||null}}catch(t){return l=`Load fail: ${t.message}`,u()}finally{i()}}function u(){return{diamonds:0,maxHealth:10,ownedSkills:Object.fromEntries(Object.keys(o).map(t=>[t,o[t].default?1/0:0])),ownedTactics:Object.fromEntries(Object.keys(r).map(t=>[t,0])),profile:null}}async function f(e){a();try{const{data:{user:n}}=await t.auth.getUser();if(!n||!n.email_confirmed_at)return;const{error:a}=await t.from("profiles").update({diamonds:e.diamonds,max_health:e.maxHealth,owned_skills:e.ownedSkills,owned_tactics:e.ownedTactics,profile:e.profile}).eq("id",n.id);if(a)throw a}catch(t){te(`Failed to save progress: ${t.message}`,"error")}finally{i()}}let h=null;const p={},m={0:"void.png",1:"grass.png",2:"wall.png",3:"water.png",4:"lava.png",5:"cactus.png",6:"cobweb.png",7:"mist.png"};const y={start:e("#start-screen"),battle:e("#battle-screen"),shop:e("#shop-screen"),scale:e("#scale-screen"),signup:e("#signup-screen"),login:e("#login-screen"),verify:e("#verify-screen"),profile:e("#profile-screen"),prize:e("#prize-screen")},b=e("#tooltip"),v=e("#messages"),M=e("#start-health"),g=e("#start-diamonds"),x=e("#start-profile"),k=e("#start-skills"),w=e("#start-tactics"),T=e("#battle-skills"),E=e("#battle-tactics"),S=e("#player-hp-fill"),L=e("#opponent-hp-fill"),C=e("#player-health-text"),$=e("#opponent-health-text"),O=e("#turn-indicator"),A=e("#btn-battle"),H=e("#btn-shop"),z=e("#btn-surrender"),P=e("#scale-dot"),D=e("#btn-stop-scale"),I=e("#btn-start-battle"),j=e("#btn-scale-back"),Y=e("#opponent-preview"),N=e("#preview-health"),F=e("#preview-skills"),q=e("#preview-tactics"),B=e("#level-select"),_=e("#shop-diamonds"),R=e("#shop-skills"),V=e("#shop-tactics"),W=e("#btn-buy-health"),K=e("#health-amount"),J=e("#btn-change-profile"),Q=e("#btn-shop-back"),X=e("#signup-form"),U=e("#login-form"),Z=e("#btn-signup"),G=e("#btn-login"),tt=e("#btn-logout"),et=e("#btn-signup-back"),nt=e("#btn-login-back"),at=e("#btn-verify-back"),it=e("#signup-username"),ot=e("#signup-email"),rt=e("#signup-password"),st=e("#login-identifier"),ct=e("#login-password"),lt=e("#user-greeting"),dt=e("#prize-dot"),ut=e("#btn-stop-prize"),ft=e("#prize-result p"),ht=e("#btn-prize-back"),pt=e("#game-canvas"),mt=pt.getContext("2d"),yt=document.createElement("canvas");yt.width=pt.width,yt.height=pt.height;const bt=yt.getContext("2d"),vt=40,Mt=Math.floor(pt.width/vt),gt=Math.floor(pt.height/vt);function xt(){const t=Array.from({length:gt},()=>Array(Mt).fill(0)),e=Math.max(1,Mt-2),n=Math.max(1,gt-2);for(let a=1;a<1+n;a++)for(let n=1;n<1+e;n++)t[a][n]=1;t[2][2]=1,t[1+n-2][1+e-2]=1,t[n/2][0]=7,t[n/2][Mt-1]=7;for(let a=0;a<60;a++){const a=2+Math.floor(Math.random()*(n-2)),i=2+Math.floor(Math.random()*(e-2));Math.random()<.28&&(t[a][i]=2)}for(let a=0;a<18;a++){const a=3+Math.floor(Math.random()*(n-4)),i=3+Math.floor(Math.random()*(e-4));1===t[a][i]&&Math.random()<.5&&(t[a][i]=3)}for(let a=0;a<12;a++){const a=3+Math.floor(Math.random()*(n-4)),i=3+Math.floor(Math.random()*(e-4));1===t[a][i]&&Math.random()<.35&&(t[a][i]=4)}for(let a=0;a<16;a++){const a=3+Math.floor(Math.random()*(n-4)),i=3+Math.floor(Math.random()*(e-4));1===t[a][i]&&Math.random()<.4&&(t[a][i]=5)}for(let a=0;a<12;a++){const a=3+Math.floor(Math.random()*(n-4)),i=3+Math.floor(Math.random()*(e-4));1===t[a][i]&&Math.random()<.3&&(t[a][i]=6)}for(let a=0;a<18;a++){const a=3+Math.floor(Math.random()*(n-4)),i=3+Math.floor(Math.random()*(e-4));1===t[a][i]&&Math.random()<.35&&(t[a][i]=0)}return t}function kt(t,e){return t>=0&&t<gt&&e>=0&&e<Mt}function wt(t,e){if(!kt(t,e))return!1;const n=Ht[t][e];return 0!==n&&2!==n}function Tt(t,e){return{x:t*vt+20,y:e*vt+20}}function Et(t,e){if(!kt(t,e))return 9999;switch(Ht[t][e]){case 1:return 1;case 3:return 1.2;case 4:return 8;case 5:return 4;case 6:return 1.5;default:return 9999}}function St(t,e,n,a,i=1){const o=Math.abs(e-a),r=Math.abs(t-n);return i*(1*(o+r)+(Math.SQRT2-2)*Math.min(o,r))}function Lt(t,e){const n=o[t];if(!n)return 0;let a=n.attack||0;const i=ve(e.x,e.y);return"Minitrident"===t&&3===i?a+=30:"Rage"===t&&e.fogMode&&(a*=2),a}function Ct(t,e,n,a,i=4e3){const o=Math.floor(t/vt),r=Math.floor(e/vt),s=Math.floor(n/vt),c=Math.floor(a/vt);if(!wt(r,o)||!wt(c,s))return null;const l=r+","+o,d=c+","+s;let u=1/0;for(let t=0;t<gt;t++)for(let e=0;e<Mt;e++){const n=Ht[t][e];1!==n&&3!==n&&6!==n||(u=Math.min(u,Et(t,e)))}isFinite(u)||(u=1);const f=new Map,h=new Set;function p(t,e){return[{r:t-1,c:e,moveCost:1},{r:t+1,c:e,moveCost:1},{r:t,c:e-1,moveCost:1},{r:t,c:e+1,moveCost:1},{r:t-1,c:e-1,moveCost:Math.SQRT2},{r:t-1,c:e+1,moveCost:Math.SQRT2},{r:t+1,c:e-1,moveCost:Math.SQRT2},{r:t+1,c:e+1,moveCost:Math.SQRT2}]}f.set(l,{r:r,c:o,g:0,f:St(r,o,c,s,u),parent:null});let m=0;for(;f.size&&m++<i;){let t=null,e=1/0;for(const[n,a]of f)a.f<e&&(e=a.f,t=n);const n=f.get(t);f.delete(t);const a=n.r+","+n.c;if(h.add(a),a===d){const t=[];let e=n;for(;e;)t.push({r:e.r,c:e.c,x:Tt(e.c,e.r).x,y:Tt(e.c,e.r).y}),e=e.parent;return t.reverse()}const i=p(n.r,n.c);for(const t of i){const e=t.r+","+t.c;if(!kt(t.r,t.c))continue;if(h.has(e))continue;if(!wt(t.r,t.c))continue;if(t.moveCost===Math.SQRT2){const e=n.r+(t.r-n.r),a=n.c,i=n.r,o=n.c+(t.c-n.c);if(!wt(e,a)||!wt(i,o))continue}const a=t.moveCost,i=.5*(Et(n.r,n.c)+Et(t.r,t.c)),o=n.g+a*i,r=f.get(e);if(!r||o<r.g){const a=St(t.r,t.c,c,s,u);f.set(e,{r:t.r,c:t.c,g:o,f:o+a,parent:n})}}}return null}function $t(t,e){if(!e||e.length<2)return!1;let n=0,a=1/0;for(let i=0;i<Math.min(e.length,4);i++){const o=t.x-e[i].x,r=t.y-e[i].y,s=o*o+r*r;s<a&&(a=s,n=i)}const i=e[Math.min(e.length-1,n+1)],o=i.x-t.x,r=i.y-t.y,s=Math.hypot(o,r)||1;return t.vx=o/s*t.getSpeed(),t.vy=r/s*t.getSpeed(),!0}function Ot(t){let e=null,n=null;for(let n=0;n<gt;n++){for(let a=0;a<Mt;a++)if(1===t[n][a]){e=[a*vt+20,n*vt+20];break}if(e)break}for(let e=gt-1;e>=0;e--){for(let a=Mt-1;a>=0;a--)if(1===t[e][a]){n=[a*vt+20,e*vt+20];break}if(n)break}return{first:e,second:n}}class At{constructor(t,e,n,a,i){this.x=t,this.y=e,this.vx=0,this.vy=0,this.hp=n,this.maxHp=n,this.speed=a,this.color=i,this.extraTurns=0,this.lastLavaTick=0,this.lastCactusTick=0,this.speedEffectEnd=0}applyDamage(t){this.hp-=t,this.hp<0&&(this.hp=0)}isDead(){return this.hp<=0}toggleFogMode(){this.fogMode=!this.fogMode}applySpeedBoost(t){this.speedEffectEnd=Date.now()+t}getSpeed(){return this.speedEffectEnd>Date.now()?1.5*this.speed:this.speed}}let Ht=xt(),zt=Ot(Ht),Pt=null,Dt=null,It={},jt={},Yt={},Nt={},Ft=0,qt=[],Bt={},_t={battle:null},Rt=null,Vt=1,Wt=0,Kt=!1,Jt=.5,Qt=null,Xt=1,Ut=0,Zt=!1;const Gt={};function te(t,e="info",n=2e3){const a=document.createElement("div");return a.className=`message ${e}`,a.innerHTML=t,v.appendChild(a),setTimeout(()=>{a.style.animation="msgOut 300ms forwards",setTimeout(()=>a.remove(),320)},n),a}function ee(){S.style.width=`${Math.max(0,Pt.hp/Pt.maxHp*100)}%`,L.style.width=`${Math.max(0,Dt.hp/Dt.maxHp*100)}%`,C&&(C.textContent=`${Math.max(0,Math.floor(Pt.hp))}/${Pt.maxHp}`),$&&($.textContent=`${Math.max(0,Math.floor(Dt.hp))}/${Dt.maxHp}`),T.innerHTML="";Object.keys(o).filter(t=>It[t]&&0!==It[t]||It[t]===1/0).forEach(t=>{const e=o[t],n=It[t]===1/0?"∞":It[t]||0,a=document.createElement("div");a.className="skill-btn",a.dataset.name=t,a.innerHTML=`<div>${t}</div><div class="skill-count">${n}</div>`,a.addEventListener("click",()=>function(t){if(!_t.battle)return;if(Date.now()<_t.battle.startPeriodEnd)return;if("player"!==_t.battle.currentActor)return;if(!It[t]||It[t]<=0&&It[t]!==1/0)return void te(`No <b>${t}</b> left!`,"warn");const e=Lt(t,Pt);Se(Pt,Dt)&&Math.random()<(o[t].acc||1)?(Dt.applyDamage(e),te(`You used <b>${t}</b>! Opponent loses ${e} HP.`,"info"),Te(L,Dt.hp/Dt.maxHp*100)):Se(Pt,Dt)?te(`You used <b>${t}</b>! Missed!`,"warn"):te(`You used <b>${t}</b>! Too far or blocked by wall.`,"warn");It[t]!==1/0&&(It[t]=Math.max(0,(It[t]||0)-1),0===It[t]&&te(`You have no <b>${t}</b> left.`,"warn"));ee(),xe("player")}(t)),ae(a,e.desc),T.appendChild(a)}),E.innerHTML="";Object.keys(r).filter(t=>jt[t]&&0!==jt[t]).forEach(t=>{const e=r[t],n=jt[t]||0,a=document.createElement("div");a.className="tactic-btn",a.dataset.name=t,a.innerHTML=`<div>${t}</div><div class="skill-count">${n}</div>`,"Emergency Platform"!==t&&a.addEventListener("click",()=>function(t){if(!_t.battle)return;if(Date.now()<_t.battle.startPeriodEnd)return;if("player"!==_t.battle.currentActor)return;if(!jt[t]||jt[t]<=0)return;"Dizzydizzy"===t?(Pt.extraTurns+=2,_t.battle&&(_t.battle.turnEndTime=Date.now()+(_t.battle.turnTimeout||1e4)),te(`You used <b>${t}</b>! 2 extra turns.`,"info")):"Pushie"===t?($e(Dt),te(`You used <b>${t}</b>! Opponent was pushed.`,"info")):"Speed"===t&&(Pt.applySpeedBoost(1e4),te(`You used <b>${t}</b>! Speed up 10s.`,"info"));jt[t]=Math.max(0,jt[t]-1),0===jt[t]&&te(`You have no <b>${t}</b> left.`,"warn");ee(),xe("player")}(t)),ae(a,`${t}<br>${e.desc}`),E.appendChild(a)})}function ne(){_.textContent=h.diamonds+("Villager"===h.profile?" (50% off!)":""),R.innerHTML="",V.innerHTML="",Object.keys(o).forEach(t=>{const e=o[t],n=document.createElement("div");n.className="shop-item",n.innerHTML=`<div><b>${t}</b><div style="font-size:13px;color:var(--muted)">${e.desc}</div></div>\n        <div style="display:flex;gap:8px;align-items:center">\n        <div style="color:var(--muted);font-weight:600">${e.price?"Villager"===h.profile?Math.ceil(e.price/2):e.price:"—"}</div>\n        <button class="btn" data-name="${t}">Buy</button>\n        </div>`,n.querySelector("button").addEventListener("click",()=>{!async function(t){a();try{const e=o[t];if(!e.price)return void te(`<b>${t}</b> cannot be purchased.`,"warn");let n=e.price;if("Villager"===h.profile&&(n=Math.ceil(n/2)),h.diamonds<n)return void te("Not enough diamonds.","error");h.diamonds-=n,h.ownedSkills[t]=(h.ownedSkills[t]||0)+1,await f(h),ne(),te(`Bought <b>${t}</b>.`,"success")}finally{i()}}(t)}),R.appendChild(n)}),Object.keys(r).forEach(t=>{const e=r[t],n=document.createElement("div");n.className="shop-item",n.innerHTML=`<div><b>${t}</b><div style="font-size:13px;color:var(--muted)">${e.desc}</div></div>\n        <div style="display:flex;gap:8px;align-items:center">\n        <div style="color:var(--muted);font-weight:600">${"Villager"===h.profile?Math.ceil(e.price/2):e.price}</div>\n        <button class="btn" data-name="${t}">Buy</button>\n        </div>`,n.querySelector("button").addEventListener("click",()=>{!async function(t){a();try{let e=r[t].price;if("Villager"===h.profile&&(e=Math.ceil(e/2)),h.diamonds<e)return void te("Not enough diamonds.","error");h.diamonds-=e,h.ownedTactics[t]=(h.ownedTactics[t]||0)+1,await f(h),ne(),te(`Bought <b>${t}</b>.`,"success")}finally{i()}}(t)}),V.appendChild(n)})}function ae(t,e){t.addEventListener("mouseenter",t=>{b.innerHTML=e,b.classList.remove("hidden"),ie(t.pageX,t.pageY)}),t.addEventListener("mousemove",t=>ie(t.pageX,t.pageY)),t.addEventListener("mouseleave",()=>{b.classList.add("hidden")})}function ie(t,e){b.style.left=t+12+"px",b.style.top=e+12+"px"}function oe(){Ht=xt(),zt=Ot(Ht);const t=h.maxHealth;Pt=new At(zt.first[0],zt.first[1],t,140,"#10b981"),Pt.fogMode=!1,Dt=new At(zt.second[0],zt.second[1],Ft,140,"#ef4444"),Dt.isChasing=!1,It={},jt={},Yt={},Nt=Bt||{},Object.keys(o).forEach(t=>{const e=h.ownedSkills[t];It[t]=e===1/0?1/0:e||0});const e=Object.keys(o).sort((t,e)=>o[e].attack-o[t].attack);let n=1;e.forEach(t=>{Yt[t]=qt.includes(t)?n++:0,"Spear"!==t&&"Knife"!==t||(Yt[t]=1/0)}),Object.keys(r).forEach(t=>{jt[t]=h.ownedTactics[t]||0}),ee();const a=document.querySelector(".sidepanel");a&&(a.scrollTop=0);_t.battle={startPeriodEnd:Date.now()+5e3,currentActor:null,turnEndTime:null,turnTimeout:1e4,battleOver:!1,startTime:Date.now()},setTimeout(()=>{_t.battle.currentActor=Math.random()<.5?"player":"opponent",_t.battle.turnEndTime=Date.now()+_t.battle.turnTimeout,we(),"opponent"===_t.battle.currentActor&&Ee()},5050),fe=performance.now(),ue||(ue=requestAnimationFrame(pe))}async function re(t){a();try{h.profile=t,await f(h),ce()}finally{i()}}function se(t){Object.keys(y).forEach(e=>{y[e].classList.toggle("hidden",e!==t)})}async function ce(){h=await d(),0===Object.keys(p).length&&await async function(){const t=Object.keys(m).map(async t=>{const e=new Image;e.src=`assets/${m[t]}`,await new Promise(t=>{e.onload=t,e.onerror=()=>{t()}}),p[t]=e});await Promise.all(t)}(),se("start"),async function(){M.textContent=h.maxHealth,g.textContent=h.diamonds,h.profile?x.textContent=h.profile:x.textContent="None",k.innerHTML="",w.innerHTML="",Object.keys(o).filter(t=>h.ownedSkills[t]&&0!==h.ownedSkills[t]).forEach(t=>{const e=o[t],n=h.ownedSkills[t]===1/0?"∞":h.ownedSkills[t],a=document.createElement("div");a.className="skill-btn",a.dataset.name=t,a.innerHTML=`<div>${t}</div><div class="skill-count">${n}</div>`,ae(a,e.desc),k.appendChild(a)}),Object.keys(r).filter(t=>h.ownedTactics[t]&&0!==h.ownedTactics[t]).forEach(t=>{const e=r[t],n=h.ownedTactics[t]||0,a=document.createElement("div");a.className="tactic-btn",a.dataset.name=t,a.innerHTML=`<div>${t}</div><div class="skill-count">${n}</div>`,ae(a,e.desc),w.appendChild(a)});const{data:{user:e}}=await t.auth.getUser();e?(Z.classList.add("hidden"),G.classList.add("hidden"),tt.classList.remove("hidden"),lt.classList.remove("hidden"),lt.textContent=e.user_metadata.username||"Anonymous"):(Z.classList.remove("hidden"),G.classList.remove("hidden"),tt.classList.add("hidden"),lt.classList.add("hidden"))}(),l&&te(l,"error",3e3)}function le(){se("profile")}function de(){Rt&&(clearInterval(Rt),Rt=null),Kt=!0,Jt=Wt/100,Y.classList.remove("hidden"),I.disabled=!1,Ft=function(){const t=s[c],e=t.maxHealth-t.minHealth;return Math.floor(t.minHealth+Jt*e)}(),qt=function(){const t=s[c],e=Math.floor(t.minSkills.length+Jt*(t.maxSkills.length-t.minSkills.length));return t.maxSkills.slice(0,Math.max(t.minSkills.length,e))}(),Bt=function(){const t=Object.keys(r),e={};if(t.forEach(t=>{e[t]=0}),"normal"===c){if(Jt>=.25&&Jt<.5){const n=t[Math.floor(Math.random()*t.length)];e[n]=1}else if(Jt>=.5&&Jt<.75){const n=t[Math.floor(Math.random()*t.length)];e[n]=2}else if(Jt>=.75&&Jt<=1){const n=[...t].sort(()=>.5-Math.random()).slice(0,2);e[n[0]]=1,e[n[1]]=2}}else if(Jt>=0&&Jt<.25)[...t].sort(()=>.5-Math.random()).slice(0,2).forEach(t=>{e[t]=2});else if(Jt>=.25&&Jt<.5){const n=[...t].sort(()=>.5-Math.random()).slice(0,3);e[n[0]]=2,e[n[1]]=2,e[n[2]]=1}else if(Jt>=.5&&Jt<.75){const n=[...t].sort(()=>.5-Math.random()).slice(0,3);e[n[0]]=3,e[n[1]]=2,e[n[2]]=2}else Jt>=.75&&Jt<=1&&t.forEach(t=>{e[t]=2});return e}(),N.textContent=Ft,F.textContent=qt.join(", ");const t=Object.entries(Bt).filter(([t,e])=>e>0).map(([t,e])=>`${t}`).join(", ");q.textContent=t||"None"}window.addEventListener("keydown",t=>{const e=t.key.toLowerCase();"tab"===e&&y.login.classList.contains("hidden")&&y.signup.classList.contains("hidden")&&t.preventDefault(),Gt[e]=!0}),window.addEventListener("keyup",t=>{Gt[t.key.toLowerCase()]=!1}),W.addEventListener("click",()=>{const t=parseInt(K.value,10);isNaN(t)||t<5||t%5!=0?te("Enter a multiple of 5 (minimum 5).","error"):async function(t){a();try{let e=t/5;if("Villager"===h.profile&&(e=Math.ceil(e/2)),h.diamonds<e)return void te("Not enough diamonds.","error");h.diamonds-=e,h.maxHealth+=t,await f(h),ne(),te(`Bought ${t} health. You have ${h.maxHealth} health now.`,"success")}finally{i()}}(t)}),K.addEventListener("click",t=>{t.stopPropagation()}),J.addEventListener("click",async()=>{h.diamonds<5?te("Not enough diamonds.","error"):(h.diamonds-=5,await f(h),le())}),A.addEventListener("click",()=>{se("scale"),Y.classList.add("hidden"),I.disabled=!0,D.disabled=!1,D.textContent="Stop",Kt=!1,Wt=50,Vt=1,P.style.left="50%",Rt=setInterval(()=>{Wt+=2*Vt,Wt>=100?(Wt=100,Vt=-1):Wt<=0&&(Wt=0,Vt=1),P.style.left=Wt+"%"},30)}),H.addEventListener("click",()=>{se("shop"),ne()}),z.addEventListener("click",()=>{_t.battle&&Ae(!1,"You surrendered.")}),Q.addEventListener("click",()=>{ce()}),D.addEventListener("click",()=>{Kt||(de(),D.disabled=!0,D.textContent="Stopped")}),I.addEventListener("click",()=>{se("battle"),oe()}),j.addEventListener("click",()=>{Kt||de(),ce()}),B.addEventListener("change",()=>{c=B.value}),Z.addEventListener("click",()=>{se("signup")}),G.addEventListener("click",()=>{se("login")}),tt.addEventListener("click",async()=>{await t.auth.signOut(),h=u(),ce()}),et.addEventListener("click",()=>ce()),nt.addEventListener("click",()=>ce()),at.addEventListener("click",()=>ce()),X.addEventListener("submit",async e=>{e.preventDefault();const n=it.value.trim(),o=ot.value.trim(),r=rt.value.trim(),s=X.querySelector('button[type="submit"]');if(n&&o&&r){s.disabled=!0,a();try{const{data:{user:e},error:a}=await t.auth.signUp({email:o,password:r,options:{data:{username:n}}});if(a)throw a;e&&se("verify")}catch(t){te(`Sign up failed: ${t.message}`,"error",3e3)}finally{s.disabled=!1,i()}}else te("All fields required.","error")}),U.addEventListener("submit",async e=>{e.preventDefault();const n=st.value.trim(),o=ct.value.trim(),r=U.querySelector('button[type="submit"]');if(n&&o){r.disabled=!0,a();try{const{data:{user:e},error:a}=await t.auth.signInWithPassword({email:n,password:o});if(a)throw a;h=await d(),h.profile?ce():le()}catch(t){te(`Log in failed: ${t.message}`,"error",3e3)}finally{r.disabled=!1,i()}}else te("All fields required.","error")}),e("#btn-warrior").addEventListener("click",()=>re("Warrior")),e("#btn-miner").addEventListener("click",()=>re("Miner")),e("#btn-trickster").addEventListener("click",()=>re("Trickster")),e("#btn-villager").addEventListener("click",()=>re("Villager")),ut.addEventListener("click",()=>{if(!Zt)if(clearInterval(Qt),Zt=!0,ut.disabled=!0,ft.parentNode.classList.remove("hidden"),Ut>50){const t=1+Math.floor(5*Math.random());if(Math.random()<.5){const e=5*t;h.maxHealth+=e,ft.innerHTML=`Prize: <b>${e} health</b>!`}else h.diamonds+=t,ft.innerHTML=`Prize: <b>${t} diamond(s)</b>!`;f(h)}else ft.textContent="Sorry, no prize."}),ht.addEventListener("click",()=>{ce()});let ue=null,fe=performance.now();function he(){ue&&cancelAnimationFrame(ue),ue=null,_t.battle=null}function pe(t){const e=Math.min(50,t-fe)/1e3;fe=t,function(t){if(!_t.battle)return;const e=Date.now();let n=Pt.getSpeed();if(Gt.w||Gt.a||Gt.s||Gt.d){let t=0,e=0;Gt.w&&(e-=1),Gt.s&&(e+=1),Gt.a&&(t-=1),Gt.d&&(t+=1);const a=Math.hypot(t,e)||1;t/=a,e/=a,Pt.vx=t*n,Pt.vy=e*n}else Pt.vx*=.8,Pt.vy*=.8;const a=_t.battle&&_t.battle.currentActor;if("opponent"===a||!Dt.hasOwnProperty("aiTimer")||Dt.aiTimer<Date.now()){const t=Math.hypot(Pt.x-Dt.x,Pt.y-Dt.y);if("player"===a)t<260?function(t,e,n){let a=null,i=-1/0;for(let o=0;o<2*Math.PI;o+=Math.PI/6){const r=t.x+Math.cos(o)*vt*3,s=t.y+Math.sin(o)*vt*3;if(r<10||s<10||r>pt.width-10||s>pt.height-10)continue;const c=ve(r,s);if(0===c||2===c||4===c)continue;const l=Math.hypot(r-e,s-n);l>i&&(i=l,a={x:r,y:s})}if(a){const e=Ct(t.x,t.y,a.x,a.y);e&&e.length>1&&$t(t,e)}}(Dt,Pt.x,Pt.y):(Dt.vx*=.85,Dt.vy*=.85),Dt.isChasing&&(Dt.isChasing=!1);else if(Se(Dt,Pt))Dt.vx*=.85,Dt.vy*=.85,Dt.isChasing&&(Dt.isChasing=!1,(!Dt.aiTimer||Dt.aiTimer<Date.now())&&Ee());else{const t=Ct(Dt.x,Dt.y,Pt.x,Pt.y);t?$t(Dt,t):Oe(Dt,Pt.x,Pt.y),Dt.isChasing=!0}}if(me(Pt,t),me(Dt,t),ye(Pt,t),ye(Dt,t),Me(Pt.x,Pt.y)){if(!(jt["Emergency Platform"]&&jt["Emergency Platform"]>0))return Pt.hp=0,Te(S,0),void setTimeout(()=>Ae(!1,"You fell into the void."),600);be(Pt.x,Pt.y)&&(jt["Emergency Platform"]--,ee())}if(Me(Dt.x,Dt.y)){if(!(Nt["Emergency Platform"]&&Nt["Emergency Platform"]>0))return Dt.hp=0,Te(L,0),void setTimeout(()=>Ae(!0,"Opponent fell into the void."),600);be(Dt.x,Dt.y)&&(Nt["Emergency Platform"]--,ee())}if(Pt.isDead())return Te(S,0),void setTimeout(()=>Ae(!1,"You died."),600);if(Dt.isDead())return Te(L,0),void setTimeout(()=>Ae(!0,"Opponent died."),600);e<_t.battle.startPeriodEnd?O.textContent=`Starting in ${Math.ceil((_t.battle.startPeriodEnd-e)/1e3)}s`:(_t.battle.currentActor?_t.battle.turnEndTime&&e>_t.battle.turnEndTime&&ke():(_t.battle.currentActor=Math.random()<.5?"player":"opponent",_t.battle.turnEndTime=e+_t.battle.turnTimeout,we()),we());S.style.width=Pt.hp/Pt.maxHp*100+"%",L.style.width=Dt.hp/Dt.maxHp*100+"%",C.textContent=`${Math.max(0,Math.floor(Pt.hp))}/${Pt.maxHp}`,$.textContent=`${Math.max(0,Math.floor(Dt.hp))}/${Dt.maxHp}`}(e),function(){mt.clearRect(0,0,pt.width,pt.height);for(let t=0;t<gt;t++)for(let e=0;e<Mt;e++){const n=Ht[t][e],a=e*vt,i=t*vt;p[n]&&mt.drawImage(p[n],a,i,vt,vt)}ge(Pt,"P"),(!Pt.fogMode||Math.hypot(Dt.x-Pt.x,Dt.y-Pt.y)<=80)&&ge(Dt,"O");Pt&&Pt.fogMode&&(bt.fillStyle="#707070",bt.fillRect(0,0,yt.width,yt.height),bt.globalCompositeOperation="destination-out",bt.beginPath(),bt.arc(Pt.x,Pt.y,80,0,2*Math.PI),bt.fill(),bt.globalCompositeOperation="source-over",mt.drawImage(yt,0,0))}(),_t.battle&&!_t.battle.battleOver?ue=requestAnimationFrame(pe):he()}function me(t,e){const n=ve(t.x,t.y);let a=1;3===n&&(a=.6),6===n&&(a=.5);const i=t.x,o=t.y;t.x+=t.vx*e*a,t.y+=t.vy*e*a;const r=Math.floor(i/vt),s=Math.floor(o/vt),c=Math.floor(t.x/vt),l=Math.floor(t.y/vt);if(l!==s&&c!==r&&!(kt(s,c)&&2!==Ht[s][c]||kt(l,r)&&2!==Ht[l][r]))return t.x=i,t.y=o,t.vx=0,void(t.vy=0);2===ve(t.x,t.y)&&(t.x=i,t.y=o,t.x+=t.vx*e*a,2===ve(t.x,t.y)&&(t.x=i),t.y+=t.vy*e*a,2===ve(t.x,t.y)&&(t.y=o),2===ve(t.x,t.y)&&(t.x=i,t.y=o,t.vx=0,t.vy=0)),t.x=Math.max(10,Math.min(pt.width-10,t.x)),t.y=Math.max(10,Math.min(pt.height-10,t.y))}function ye(t,e){const n=Date.now(),a=ve(t.x,t.y);4===a?(t.lastLavaTick||(t.lastLavaTick=n),n-t.lastLavaTick>=250&&(t.applyDamage(20),t.lastLavaTick=n,t===Pt&&te("Sizzling in lava!","warn"))):t.lastLavaTick=0,5===a?(t.lastCactusTick||(t.lastCactusTick=n),n-t.lastCactusTick>=250&&(t.applyDamage(5),t.lastCactusTick=n,t===Pt&&te("Pricked by cactus!","warn"))):t.lastCactusTick=0,7===a?(!t.lastMistToggle||n-t.lastMistToggle>=3e3)&&(t.toggleFogMode(),te(t.fogMode?"Mist obscures your vision!":"Vision restored!","info"),t.lastMistToggle=n):t.lastMistToggle=0}function be(t,e){const n=Math.floor(t/vt),a=Math.floor(e/vt);return!(!kt(a,n)||0!==Ht[a][n])&&(Ht[a][n]=1,te("Emergency Platform activated!","success"),!0)}function ve(t,e){const n=Math.floor(t/vt),a=Math.floor(e/vt);return a<0||a>=gt||n<0||n>=Mt?0:Ht[a][n]}function Me(t,e){const n=Math.floor(t/vt),a=Math.floor(e/vt);return a<0||a>=gt||n<0||n>=Mt||0===Ht[a][n]}function ge(t,e){mt.save(),mt.beginPath(),mt.fillStyle=t.color,mt.strokeStyle="#000",mt.lineWidth=2,mt.arc(t.x,t.y,14,0,2*Math.PI),mt.fill(),mt.stroke(),mt.closePath(),mt.fillStyle="#fff",mt.font="bold 14px Inter",mt.textAlign="center",mt.textBaseline="middle",mt.fillText(e,t.x,t.y),mt.restore()}function xe(t){if("player"===t){if(Pt.extraTurns>0)return void Pt.extraTurns--;ke()}else{if(Dt.extraTurns>0)return Dt.extraTurns--,void Ee();ke()}}function ke(){_t.battle&&("player"===_t.battle.currentActor?(_t.battle.currentActor="opponent",_t.battle.turnEndTime=Date.now()+_t.battle.turnTimeout,Ee()):(_t.battle.currentActor="player",_t.battle.turnEndTime=Date.now()+_t.battle.turnTimeout),we())}function we(){if(!_t.battle)return;const t=Date.now();if(t<_t.battle.startPeriodEnd)return void(O.textContent=`Starting in ${Math.ceil((_t.battle.startPeriodEnd-t)/1e3)}s`);const e=_t.battle.currentActor;if("player"===e){const e=Math.max(0,Math.ceil((_t.battle.turnEndTime-t)/1e3));O.textContent=`Your turn — ${e}s`}else if("opponent"===e){const e=Math.max(0,Math.ceil((_t.battle.turnEndTime-t)/1e3));O.textContent=`Opponent's turn — ${e}s`}else O.textContent="Waiting..."}function Te(t,e){t.style.width=`${e}%`}function Ee(){if(!_t.battle||"opponent"!==_t.battle.currentActor)return;if(!Se(Dt,Pt))return void(Dt.isChasing=!0);const t=800+1e3*Math.random();Dt.aiTimer=Date.now()+t,setTimeout(()=>{if(!_t.battle||"opponent"!==_t.battle.currentActor)return;if(!Se(Dt,Pt))return void(Dt.isChasing=!0);const t=ve(Dt.x,Dt.y);if(4===t||5===t){const t=function(t){const e=6;for(let n=-e;n<=e;n++)for(let a=-e;a<=e;a++){const e=t.x+a*vt,i=t.y+n*vt;if(e<=10||i<=10||e>=pt.width-10||i>=pt.height-10)continue;const o=ve(e,i);if(1===o||6===o)return{x:e,y:i}}return null}(Dt);t&&Oe(Dt,t.x,t.y)}const e=Object.keys(o).filter(t=>Yt[t]&&0!==Yt[t]||Yt[t]===1/0),n=Object.keys(r).filter(t=>Nt[t]&&Nt[t]>0);for(const t of e){const e=o[t];let n=e.attack;const a=ve(Dt.x,Dt.y);if("Minitrident"===t&&3===a&&(n+=30),n>=Pt.hp&&Math.random()<(e.acc||1))return void Le(t)}if(n.includes("Pushie")){const t=Pt.x,e=pt.width-Pt.x,n=Pt.y,a=pt.height-Pt.y;if(Math.min(t,e,n,a)<140&&Math.random()<.6)return void Ce("Pushie")}if(n.includes("Dizzydizzy")&&Math.random()<.6)return void Ce("Dizzydizzy");if(n.includes("Speed")&&Dt.hp<=.6*Dt.maxHp&&Math.random()<.5)return void Ce("Speed");let a=null,i=-1/0;for(const t of e){const e=o[t];let n=e.attack;const r=ve(Dt.x,Dt.y);"Minitrident"===t&&3===r&&(n+=30);let s=e.acc||1;"Warrior"===h.profile&&(s=.5);const c=n*s;c>i&&(i=c,a=t)}a&&Le(a),setTimeout(()=>{"opponent"===_t.battle.currentActor&&ke()},800+600*Math.random())},t)}function Se(t,e){const n=e.x-t.x,a=e.y-t.y,i=Math.hypot(n,a);if(i>410)return!1;const o=Math.ceil(i/8);for(let e=1;e<o;e++){if(2===ve(t.x+n*(e/o),t.y+a*(e/o)))return!1}return!0}function Le(t){if(!_t.battle||"opponent"!==_t.battle.currentActor)return;if(!Yt[t]||Yt[t]<=0&&Yt[t]!==1/0)return void ke();const e=Lt(t,Dt);let n=o[t].acc||1;"Warrior"===h.profile&&(n=.5),Se(Dt,Pt)&&Math.random()<n?(Pt.applyDamage(e),te(`Opponent used <b>${t}</b>! You lose ${e} HP.`,"error"),Te(S,Pt.hp/Pt.maxHp*100)):Se(Dt,Pt)?te(`Opponent used <b>${t}</b>! Missed!`,"info"):te(`Opponent used <b>${t}</b>! Too far or blocked by wall.`,"info"),Yt[t]!==1/0&&(Yt[t]=Math.max(0,Yt[t]-1)),xe("opponent")}function Ce(t){_t.battle&&"opponent"===_t.battle.currentActor&&(!Nt[t]||Nt[t]<=0?ke():("Dizzydizzy"===t?(Dt.extraTurns+=2,_t.battle&&(_t.battle.turnEndTime=Date.now()+(_t.battle.turnTimeout||1e4)),te("Opponent used <b>Dizzydizzy</b>! They gain 2 extra turns.","warn")):"Pushie"===t?($e(Pt),te("Opponent used <b>Pushie</b>! You were pushed.","warn")):"Speed"===t&&(Dt.applySpeedBoost(1e4),te("Opponent used <b>Speed</b>! Opponent speed +50% for 10s.","warn")),Nt[t]=Math.max(0,Nt[t]-1),xe("opponent")))}function $e(t){const e=[{x:10,y:t.y},{x:pt.width-10,y:t.y},{x:t.x,y:10},{x:t.x,y:pt.height-10}];let n=null,a=1/0;for(const i of e){const e=Math.hypot(i.x-t.x,i.y-t.y);e<a&&(a=e,n=i)}const i=Math.min(100,a),o=Math.atan2(n.y-t.y,n.x-t.x);t.x+=Math.cos(o)*i,t.y+=Math.sin(o)*i}function Oe(t,e,n){const a=Ct(t.x,t.y,e,n);a&&a.length>1&&$t(t,a)}async function Ae(t,e){if(!_t.battle||_t.battle.battleOver)return;const n=_t.battle;_t.battle.battleOver=!0,he();let a=Math.floor(15*Jt)+("normal"===c?2:12);if(t?("Miner"===h.profile&&(a*=2),h.diamonds=(h.diamonds||0)+a,await f(h),te(`You win! ${e} Diamonds earned: ${a}`,"success")):te(`You lose. ${e}`,"error"),"Trickster"===h.profile){if(!(Date.now()-n.startTime<11e3))return se("prize"),ft.parentNode.classList.add("hidden"),ut.disabled=!1,ut.textContent="Stop",Ut=0,Xt=1,dt.style.left="0%",Zt=!1,void(Qt=setInterval(()=>{Ut+=5*Xt,Ut>=100?(Ut=100,Xt=-1):Ut<=0&&(Ut=0,Xt=1),dt.style.left=Ut+"%"},30));te("Sorry, no cheating the prize! You must battle for a while.","warn",3e3)}ce()}ce()})();